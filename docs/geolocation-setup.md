# 地理位置获取功能说明

## 功能概述

本项目已实现真实的地理位置获取功能，不再固定显示北京天气，而是根据用户的实际位置获取对应的天气信息。

## 技术实现

### 1. 地理位置获取流程

```
用户访问页面 → 请求地理位置权限 → 获取经纬度 → 逆地理编码 → 获取区域ID → 调用天气API
```

### 2. 核心功能

#### getCurrentPosition()
- 使用浏览器的 `navigator.geolocation` API
- 获取用户的精确经纬度坐标
- 设置10秒超时和高精度模式
- 失败时降级使用北京坐标

#### getDistrictId()
- 调用百度地图逆地理编码API
- 将经纬度转换为具体的城市和区域信息
- 通过城市区域映射表获取对应的district_id
- 支持北京、上海、广州、深圳等主要城市

### 3. 代理配置

在 `vite.config.ts` 中配置了两个代理：

```typescript
// 天气API代理
'/api/weather': {
  target: 'https://api.map.baidu.com',
  rewrite: (path) => path.replace(/^\/api\/weather/, '/weather/v1')
}

// 逆地理编码API代理
'/api/geocode': {
  target: 'https://api.map.baidu.com',
  rewrite: (path) => path.replace(/^\/api\/geocode/, '/reverse_geocoding/v3')
}
```

### 4. 城市区域映射

项目内置了主要城市的区域ID映射表：

- **北京市**：东城区(110101)、西城区(110102)、朝阳区(110105)等
- **上海市**：黄浦区(310101)、徐汇区(310104)、长宁区(310105)等
- **广州市**：荔湾区(440103)、越秀区(440104)、海珠区(440105)等
- **深圳市**：罗湖区(440303)、福田区(440304)、南山区(440305)等

## 使用说明

### 1. 首次访问
- 浏览器会请求地理位置权限
- 用户需要点击"允许"以获取精确位置
- 系统会自动获取当前位置的天气信息

### 2. 权限被拒绝
- 如果用户拒绝地理位置权限
- 系统会自动使用北京东城区作为默认位置
- 可以在浏览器设置中重新开启位置权限

### 3. 调试信息

在浏览器控制台可以看到详细的调试信息：
- 📍 获取到位置: {lat: xx, lng: xx}
- 🗺️ 逆地理编码响应: {...}
- 📍 解析到的城市: xx 区域: xx
- 🏙️ 映射的区域ID: xxxxxx

## 错误处理

### 1. 地理位置获取失败
- 浏览器不支持地理位置API
- 用户拒绝权限
- 网络超时
- **降级方案**：使用北京东城区(110101)

### 2. 逆地理编码失败
- API调用失败
- 返回数据格式错误
- **降级方案**：使用北京东城区(110101)

### 3. 城市映射失败
- 城市不在映射表中
- 区域名称不匹配
- **降级方案**：使用城市的第一个区域或北京东城区

## 扩展说明

### 添加新城市支持

在 `getDistrictIdByLocation` 函数的 `locationMap` 中添加新的城市映射：

```typescript
const locationMap: Record<string, Record<string, string>> = {
  // 现有城市...
  '新城市': {
    '区域1': 'district_id_1',
    '区域2': 'district_id_2'
  }
}
```

### 提高精度

- 可以集成更完整的城市区域映射数据库
- 使用更精确的地理位置服务
- 添加用户手动选择位置的功能

## 注意事项

1. **HTTPS要求**：地理位置API只能在HTTPS环境下工作
2. **权限管理**：用户可以随时在浏览器中撤销位置权限
3. **隐私保护**：位置信息仅用于获取天气数据，不会存储或上传
4. **API配额**：百度地图API有调用次数限制，生产环境需要注意配额管理